<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMS Streaming Test</title>
    <script src="https://unpkg.com/rsocket-core@0.0.27/build/index.js"></script>
    <script src="https://unpkg.com/rsocket-websocket-client@0.0.27/build/index.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #00d9ff; }
        .container { display: flex; gap: 20px; }
        .panel { flex: 1; background: #16213e; padding: 15px; border-radius: 8px; }
        .log { background: #0f0f23; padding: 10px; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #00d9ff; }
        .log-entry.error { border-color: #ff4444; }
        .log-entry.success { border-color: #44ff44; }
        button { background: #00d9ff; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #00b8d4; }
        button:disabled { background: #666; cursor: not-allowed; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .status.connected { background: #1b5e20; }
        .status.disconnected { background: #b71c1c; }
        .order-card { background: #1a1a2e; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 3px solid #ffc107; }
        .order-card .symbol { font-weight: bold; color: #ffc107; }
        .order-card .side-buy { color: #4caf50; }
        .order-card .side-sell { color: #f44336; }
    </style>
</head>
<body>
    <h1>üöÄ OMS Trade Blotter - Streaming Test</h1>
    
    <div class="status disconnected" id="status">Disconnected</div>
    
    <div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="container">
        <div class="panel">
            <h3>üìä Order Events</h3>
            <div class="log" id="orderLog"></div>
        </div>
        <div class="panel">
            <h3>üìù Connection Log</h3>
            <div class="log" id="connectionLog"></div>
        </div>
    </div>

    <script>
        let socket = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('connectionLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }
        
        function logOrder(order) {
            const logDiv = document.getElementById('orderLog');
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const sideClass = order.side === 'BUY' ? 'side-buy' : 'side-sell';
            card.innerHTML = `
                <div><span class="symbol">${order.symbol || 'N/A'}</span> - <span class="${sideClass}">${order.side || 'N/A'}</span></div>
                <div>Order ID: ${order.orderId || 'N/A'}</div>
                <div>Qty: ${order.orderQty || 'N/A'} @ ${order.price || 'N/A'}</div>
                <div>State: ${order.state || 'N/A'}</div>
                <div>Event: ${order.eventType || 'UPDATE'}</div>
            `;
            logDiv.insertBefore(card, logDiv.firstChild);
        }
        
        function updateStatus(connected) {
            const status = document.getElementById('status');
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
            status.textContent = connected ? 'Connected to RSocket' : 'Disconnected';
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
        }
        
        function connect() {
            log('Connecting to ws://localhost:7000/trade-blotter/stream...');
            
            // Simple WebSocket connection to see if the endpoint is reachable
            // Note: Full RSocket requires the rsocket-js library properly loaded
            socket = new WebSocket('ws://localhost:7000/trade-blotter/stream');
            
            socket.onopen = () => {
                log('WebSocket connected!', 'success');
                updateStatus(true);
                
                // For RSocket, we need to send a SETUP frame
                // This is a simplified test - real RSocket needs proper framing
                log('Note: This is a basic WebSocket test. For full RSocket, use rsocket-js or rsc CLI.');
            };
            
            socket.onmessage = (event) => {
                log(`Received: ${event.data.substring(0, 100)}...`);
                try {
                    // Try to parse as JSON (may not work with raw RSocket frames)
                    const data = JSON.parse(event.data);
                    if (data.orderId) {
                        logOrder(data);
                    }
                } catch (e) {
                    log(`Raw data received (${event.data.length} bytes)`);
                }
            };
            
            socket.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
            
            socket.onclose = (event) => {
                log(`WebSocket closed: ${event.code} - ${event.reason}`, 'error');
                updateStatus(false);
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
                log('Disconnected');
                updateStatus(false);
            }
        }
        
        function clearLogs() {
            document.getElementById('orderLog').innerHTML = '';
            document.getElementById('connectionLog').innerHTML = '';
        }
        
        // Auto-connect on page load
        // connect();
    </script>
</body>
</html>
